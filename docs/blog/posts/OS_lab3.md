---
comments: true
authors:
    - stormckey
categories:
    - Lab
    - OS
date: 2023-11-25
nostatistics: true
---
# 操作系统 - lab3 虚拟内存
!!! abstract
    比较 high level 的讲一下一些思想和需要注意的地方，很多细节问题还是要自己决定和思考的哒
<!-- more -->

!!! info "基本信息"
    时间：2023 秋冬

    实验文档：[:octicons-book-16:](https://zju-sec.github.io/os23fall-stu/lab3/)

??? warning "为什么是从 lab3 开始？"
    我也不知道


##  初步启用虚拟内存

启用虚拟内存，在本实验的语境下，其实就是设置 satp 寄存器的那一下.在此之前，我们得先搞一个页表出来.

注意到我们写 satp 的那一步只是一个`csrw`，所以这句话结束后我们启用了虚拟内存并且将要继续去 PC+4 执行下一条指令，所以 PC+4 这个地址在虚拟内存中该怎么被正确的处理就是个问题，这个问题就是思考题所关心的.

??? info "为什么在这一步中我们启用的页表是一级的"
    文档中其实已经有链接指向了解释这一点的文档，具体而言，是这段描述转化虚拟内存的过程的[:octicons-book-16:手册](https://www.five-embeddev.com/riscv-isa-manual/latest/supervisor.html#sv32algorithm)

    仔细阅读，其中第四点提到若当前页表项的权限表明了可读或者可执行，那么就会直接跳走，当作是最后一级，否则才会把它当作某一级的页表

!!! bug
    当我们按照文档修改了链接文件后，我们 gdb 中直接用符号来打断点之类的操作就都是按照修改了链接文件之后的虚拟地址了，所以启用虚拟内存之前为了在正确的物理地址打断点，需要手动输入地址.

## 完全启用虚拟内存

这一步我们将使用多级页表并且分级进行权限设置.主要就是设置一个写入页表的函数，并且调用该函数来分权限填写页表.

时刻注意什么地方要填物理地址，什么地方要用虚拟地址.在页表中，我们要填物理地址.

!!! bug
    如果你跟我一样改完页表没事，但是一刷新 tlb 就寄了.与我的经验而言，是页表写的有问题.


---
commnets: true
---

# Minisql\#1 Disk and BufferPoolManager

!!! abstract
    这一部分主要负责与内存磁盘空间申请释放等打交道，在项目中的地位大概相当于`new` `delete`，所以这一部分在后续会被频繁调用，也是直接与磁盘 IO 打交道的，实现既要求正确又要求效率

### 动机

假设我们手头上现在有 65536（4096*16）页（一页为 4096Bytes）的数据需要存在磁盘上，最自然的想法就是数组，实际上是变长数组，因为我们可以在文件尾继续写入新的页。

但是，数据库会对数据进行删除.假设我们分配出去第 0-9 页用于记录某个表，然后删除了其中第 2，4，6 页的数据，那么下次再请求页面来存储信息的时候，就可以用这空闲的三页来存储.不这样做，那么面对申请 100 页，删 100 页，申请 100 页，删 100 页这样的操作，本来只要 100 页的空间就可以实现，实际上却会花的多得多。

这就引出了 BitMap，我们只要拿出一页来，把这一页 4096 个 Byte，即 32768 个 bit，每个 bit 的 0 指示该页未被使用，1 指示已经被使用，这样这一页就可以管理其后的 32768 页了，我们每次都现在其中找 0，没有 0 了，才去新开一页。

当然实际上这一页的 4096B 我们不会都拿去用来记录使用情况，还有一些元数据比如记录目前以占用的有 10 页等等。

但注意第一段假设我们有 65536 页要存，一页 BitMap 不够，那就多来几个.我们把 1 页 BitMap 和后面的（大概）32767 页称为一段(extent)，我们需要两段来存储 65536 页，在最前面来个 Disk Meta Page 来管理所有页。
